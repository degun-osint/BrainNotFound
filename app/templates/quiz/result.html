{% extends "base.html" %}

{% block title %}{{ _('Resultat') }} - {{ quiz_response.quiz.title }} - BrainNotFound{% endblock %}

{% block content %}
{% if quiz_response.is_test %}
<div class="preview-banner mb-2 flex justify-between items-center">
    <div>
        <h3><i class="iconoir-flask"></i> {{ _('Resultat de test') }}</h3>
        <p class="text-sm" style="opacity: 0.9;">{{ _('Ceci est un test admin - non comptabilise dans les statistiques.') }}</p>
    </div>
    <a href="{{ url_for('admin.preview_quiz', identifier=quiz_response.quiz.get_url_identifier()) }}" class="btn btn-small btn-ghost">
        <i class="iconoir-arrow-left"></i> {{ _('Retour preview') }}
    </a>
</div>
{% endif %}

<h1 class="mb-2">{{ _('Resultats :') }} {{ quiz_response.quiz.title }}</h1>

<div class="score-banner">
    <div class="score-value">{{ "%.2f"|format(quiz_response.total_score) }} / {{ "%.2f"|format(quiz_response.max_score) }}</div>
    <div class="score-label">
        {% set percentage = (quiz_response.total_score / quiz_response.max_score * 100) if quiz_response.max_score > 0 else 0 %}
        {{ _('Soit') }} {{ "%.1f"|format(percentage) }}% {{ _('de reussite') }}
    </div>
    <div class="mt-1 text-sm">
        {{ _('Soumis le') }} {{ quiz_response.submitted_at|localtime }}
        {% if quiz_response.is_late %}
        <span class="badge badge-error ml-1">{{ _('Soumission en retard') }}</span>
        {% endif %}
        {% if quiz_response.started_at %}
        <br>
        {% set duration_minutes = ((quiz_response.submitted_at - quiz_response.started_at).total_seconds() / 60) %}
        {{ _('Duree :') }} {{ "%.1f"|format(duration_minutes) }} {{ _('minutes') }}
        {% if quiz_response.quiz.time_limit_minutes %}
        / {{ quiz_response.quiz.time_limit_minutes }} {{ _('minutes allouees') }}
        {% endif %}
        {% endif %}
    </div>
</div>

{% if quiz_response.admin_comment %}
<div class="card mb-2">
    <div class="card-header">
        <i class="iconoir-message-text"></i> {{ _('Commentaire du correcteur') }}
    </div>
    <div class="p-1 whitespace-pre">{{ quiz_response.admin_comment }}</div>
</div>
{% endif %}

{% if quiz_response.quiz.randomize_questions %}
<div class="alert alert-info mb-2">
    <i class="iconoir-info-circle"></i>
    <span>{{ _('Les questions etaient affichees dans un ordre aleatoire pendant l\'examen. Ci-dessous, elles sont presentees dans l\'ordre original du quiz.') }}</span>
</div>
{% endif %}

<h2 class="mb-1">{{ _('Details des reponses') }}</h2>

{% for question in questions %}
    {% set answer = answers_by_question.get(question.id) %}
    {% if answer %}
        {% set percentage = (answer.score / answer.max_score * 100) if answer.max_score > 0 else 0 %}
        {% if percentage == 100 %}
            {% set answer_class = "answer-correct" %}
        {% elif percentage > 0 %}
            {% set answer_class = "answer-partial" %}
        {% else %}
            {% set answer_class = "answer-incorrect" %}
        {% endif %}
    {% else %}
        {% set answer_class = "" %}
    {% endif %}

    <div class="question {{ answer_class }}">
        <div class="question-header">
            <span class="question-type">{{ question.question_type|upper }}</span>
            <span class="question-points">
                {{ "%.2f"|format(answer.score if answer else 0) }} / {{ "%.2f"|format(question.points) }} {{ _('points') }}
            </span>
        </div>

        <div class="question-text">{{ question.question_text|render_quiz_images(quiz_response.quiz.id) }}</div>

        {% if question.question_type == 'mcq' %}
            <ul class="options">
                {% for option in question.options %}
                <li class="option {% if loop.index0 in question.correct_answers %}option-correct{% endif %} {% if answer and loop.index0 in answer.selected_options and loop.index0 not in question.correct_answers %}option-incorrect{% endif %}">
                    {% if answer and loop.index0 in answer.selected_options %}
                        <i class="iconoir-check"></i>
                    {% endif %}
                    {{ option|render_quiz_images(quiz_response.quiz.id) }}
                    {% if loop.index0 in question.correct_answers %}
                        <span class="text-success font-bold ml-1"><i class="iconoir-check"></i> {{ _('Correct') }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="mt-1">
                <strong>{{ _('Votre reponse :') }}</strong>
                <div class="answer-box mt-0 whitespace-pre">{{ answer.answer_text if answer else _('Aucune reponse') }}</div>
            </div>

            {% if question.expected_answer %}
            <div class="mt-1">
                <strong>{{ _('Reponse attendue :') }}</strong>
                <div class="expected-answer mt-0 whitespace-pre">{{ question.expected_answer }}</div>
            </div>
            {% endif %}

            {% if answer and answer.ai_feedback %}
            <div class="feedback">
                <strong>{{ _('Correction :') }}</strong>
                <p class="mt-0">{{ answer.ai_feedback }}</p>
            </div>
            {% endif %}
        {% endif %}
    </div>
{% endfor %}

<div class="mt-2">
    <a href="{{ url_for('quiz.quiz_list') }}" class="btn btn-primary">
        <i class="iconoir-arrow-left"></i> {{ _('Retour aux quiz') }}
    </a>
</div>
{% endblock %}
