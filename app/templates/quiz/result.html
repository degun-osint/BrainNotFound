{% extends "base.html" %}

{% block title %}Résultat - {{ quiz_response.quiz.title }} - BrainNotFound{% endblock %}

{% block content %}
{% if quiz_response.is_test %}
<div class="preview-banner mb-2 flex justify-between items-center">
    <div>
        <h3><i class="iconoir-flask"></i> Résultat de test</h3>
        <p class="text-sm" style="opacity: 0.9;">Ceci est un test admin - non comptabilisé dans les statistiques.</p>
    </div>
    <a href="{{ url_for('admin.preview_quiz', quiz_id=quiz_response.quiz.id) }}" class="btn btn-small btn-ghost">
        <i class="iconoir-arrow-left"></i> Retour preview
    </a>
</div>
{% endif %}

<h1 class="mb-2">Résultats : {{ quiz_response.quiz.title }}</h1>

<div class="score-banner">
    <div class="score-value">{{ "%.2f"|format(quiz_response.total_score) }} / {{ "%.2f"|format(quiz_response.max_score) }}</div>
    <div class="score-label">
        {% set percentage = (quiz_response.total_score / quiz_response.max_score * 100) if quiz_response.max_score > 0 else 0 %}
        Soit {{ "%.1f"|format(percentage) }}% de réussite
    </div>
    <div class="mt-1 text-sm">
        Soumis le {{ quiz_response.submitted_at.strftime('%d/%m/%Y à %H:%M') }}
        {% if quiz_response.is_late %}
        <span class="badge badge-error ml-1">Soumission en retard</span>
        {% endif %}
        {% if quiz_response.started_at %}
        <br>
        {% set duration_minutes = ((quiz_response.submitted_at - quiz_response.started_at).total_seconds() / 60) %}
        Duree : {{ "%.1f"|format(duration_minutes) }} minutes
        {% if quiz_response.quiz.time_limit_minutes %}
        / {{ quiz_response.quiz.time_limit_minutes }} minutes allouees
        {% endif %}
        {% endif %}
    </div>
</div>

{% if quiz_response.admin_comment %}
<div class="card mb-2">
    <div class="card-header">
        <i class="iconoir-message-text"></i> Commentaire du correcteur
    </div>
    <div class="p-1 whitespace-pre">{{ quiz_response.admin_comment }}</div>
</div>
{% endif %}

{% if quiz_response.quiz.randomize_questions %}
<div class="alert alert-info mb-2">
    <i class="iconoir-info-circle"></i>
    <span>Les questions étaient affichées dans un ordre aléatoire pendant l'examen. Ci-dessous, elles sont présentées dans l'ordre original du quiz.</span>
</div>
{% endif %}

<h2 class="mb-1">Détails des réponses</h2>

{% for question in questions %}
    {% set answer = answers_by_question.get(question.id) %}
    {% if answer %}
        {% set percentage = (answer.score / answer.max_score * 100) if answer.max_score > 0 else 0 %}
        {% if percentage == 100 %}
            {% set answer_class = "answer-correct" %}
        {% elif percentage > 0 %}
            {% set answer_class = "answer-partial" %}
        {% else %}
            {% set answer_class = "answer-incorrect" %}
        {% endif %}
    {% else %}
        {% set answer_class = "" %}
    {% endif %}

    <div class="question {{ answer_class }}">
        <div class="question-header">
            <span class="question-type">{{ question.question_type|upper }}</span>
            <span class="question-points">
                {{ "%.2f"|format(answer.score if answer else 0) }} / {{ "%.2f"|format(question.points) }} points
            </span>
        </div>

        <div class="question-text">{{ question.question_text|render_quiz_images(quiz_response.quiz.id) }}</div>

        {% if question.question_type == 'mcq' %}
            <ul class="options">
                {% for option in question.options %}
                <li class="option {% if loop.index0 in question.correct_answers %}option-correct{% endif %} {% if answer and loop.index0 in answer.selected_options and loop.index0 not in question.correct_answers %}option-incorrect{% endif %}">
                    {% if answer and loop.index0 in answer.selected_options %}
                        <i class="iconoir-check"></i>
                    {% endif %}
                    {{ option|render_quiz_images(quiz_response.quiz.id) }}
                    {% if loop.index0 in question.correct_answers %}
                        <span class="text-success font-bold ml-1"><i class="iconoir-check"></i> Correct</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="mt-1">
                <strong>Votre réponse :</strong>
                <div class="answer-box mt-0 whitespace-pre">{{ answer.answer_text if answer else "Aucune réponse" }}</div>
            </div>

            {% if question.expected_answer %}
            <div class="mt-1">
                <strong>Réponse attendue :</strong>
                <div class="expected-answer mt-0 whitespace-pre">{{ question.expected_answer }}</div>
            </div>
            {% endif %}

            {% if answer and answer.ai_feedback %}
            <div class="feedback">
                <strong>Correction :</strong>
                <p class="mt-0">{{ answer.ai_feedback }}</p>
            </div>
            {% endif %}
        {% endif %}
    </div>
{% endfor %}

<div class="mt-2">
    <a href="{{ url_for('quiz.quiz_list') }}" class="btn btn-primary">
        <i class="iconoir-arrow-left"></i> Retour aux quiz
    </a>
</div>
{% endblock %}
