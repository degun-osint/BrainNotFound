{% extends "base.html" %}

{% block title %}{{ _('Dashboard Admin - BrainNotFound') }}{% endblock %}

{% block content %}
<h1 class="mb-2">{{ _('Dashboard Administrateur') }}</h1>

{% if fallback_warnings %}
<div class="alert alert-warning mb-2">
    <i class="iconoir-warning-triangle"></i>
    <div>
        <strong>{{ _('Configuration par defaut detectee') }}</strong>
        <ul class="mt-1 mb-0" style="margin-left: 1.5em;">
        {% for warning in fallback_warnings %}
            <li>{{ warning.message }}</li>
        {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_quizzes }}</div>
        <div class="stat-label">{{ _('Quiz créés') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_interviews or 0 }}</div>
        <div class="stat-label">{{ _('Entretiens') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_groups }}</div>
        <div class="stat-label">{{ _('Groupes') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_users }}</div>
        <div class="stat-label">{{ _('Utilisateurs') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_responses }}</div>
        <div class="stat-label">{{ _('Réponses soumises') }}</div>
    </div>
</div>

{% if pending_grading > 0 %}
<div class="alert alert-warning mb-2">
    <i class="iconoir-hourglass"></i>
    <span><strong>{{ pending_grading }}</strong> {{ _('correction(s) en attente ou en cours') }}</span>
</div>
{% endif %}

{% if recent_interviews %}
<div class="card mb-2">
    <div class="card-header flex justify-between items-center">
        <span><i class="iconoir-chat-bubble"></i> {{ _('Entretiens recents') }}</span>
        <a href="{{ url_for('interview.admin_list') }}" class="btn btn-secondary btn-small">{{ _('Voir tout') }}</a>
    </div>
    <div class="recent-activity">
        {% for session in recent_interviews %}
        <div class="activity-item flex justify-between items-center gap-sm">
            <div class="flex-1">
                <a href="{{ url_for('admin.user_grades', identifier=session.user.get_url_identifier()) }}" class="font-medium link-primary">
                    {{ session.user.full_name }}
                </a>
                {{ _('a passe') }}
                <a href="{{ url_for('interview.admin_session', identifier=session.interview.get_url_identifier(), session_identifier=session.get_url_identifier()) }}" class="link-primary">
                    {{ session.interview.title|truncate(30) }}
                </a>
            </div>
            <div class="flex gap-sm items-center">
                {% if session.status == 'completed' %}
                {% set percentage = session.get_score_percentage() %}
                <span class="badge {% if percentage >= 80 %}badge-success{% elif percentage >= 50 %}badge-warning{% else %}badge-error{% endif %}">
                    {{ "%.0f"|format(percentage) }}%
                </span>
                {% elif session.status == 'in_progress' %}
                <span class="badge badge-warning">{{ _('En cours') }}</span>
                {% elif session.status == 'evaluating' %}
                <span class="badge badge-info">{{ _('Evaluation') }}</span>
                {% endif %}
                <span class="text-light text-sm">{{ session.started_at|localtime_short }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if all_groups %}
<div class="card mb-2">
    <div class="card-header flex justify-between items-center">
        <span><i class="iconoir-group"></i> {{ _('Mes Groupes') }}</span>
        <a href="{{ url_for('admin.groups') }}" class="btn btn-secondary btn-small">{{ _('Voir tout') }}</a>
    </div>
    <div class="group-codes-grid">
        {% for group in all_groups[:6] %}
        <div class="group-code-card">
            <div class="group-code-name">{{ group.name }}</div>
            <div class="group-code-value">
                <span class="font-mono">{{ group.join_code }}</span>
                <button type="button" class="btn btn-icon btn-small" onclick="copyToClipboard('{{ group.join_code }}')" data-tooltip="{{ _('Copier le code') }}">
                    <i class="iconoir-copy"></i>
                </button>
            </div>
            <div class="group-code-meta text-sm text-light">
                {{ group.get_member_count() }}{% if group.max_members and group.max_members > 0 %}/{{ group.max_members }}{% endif %} {{ _('membre(s)') }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if recent_responses %}
<div class="card mb-2">
    <div class="card-header">
        <i class="iconoir-clock"></i> {{ _('Activite recente') }}
    </div>
    <div class="recent-activity">
        {% for response in recent_responses %}
        <div class="activity-item flex justify-between items-center gap-sm">
            <div class="flex-1">
                <a href="{{ url_for('admin.user_grades', identifier=response.user.get_url_identifier()) }}" class="font-medium link-primary">
                    {{ response.user.full_name }}
                </a>
                {{ _('a soumis') }}
                <a href="{{ url_for('admin.quiz_results', identifier=response.quiz.get_url_identifier()) }}" class="link-primary">
                    {{ response.quiz.title|truncate(30) }}
                </a>
            </div>
            <div class="flex gap-sm items-center">
                {% set percentage = (response.total_score / response.max_score * 100) if response.max_score > 0 else 0 %}
                <span class="badge {% if percentage >= 80 %}badge-success{% elif percentage >= 50 %}badge-warning{% else %}badge-error{% endif %}">
                    {{ "%.0f"|format(percentage) }}%
                </span>
                <span class="text-light text-sm">{{ response.submitted_at|localtime_short }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <i class="iconoir-rocket"></i> {{ _('Actions rapides') }}
    </div>
    <div class="card-body">
        <div class="quick-actions-grid">
            <a href="{{ url_for('admin.quiz_list') }}" class="quick-action-card">
                <i class="iconoir-clipboard-check"></i>
                <span>{{ _('Voir les Quiz') }}</span>
            </a>
            <a href="{{ url_for('admin.create_quiz') }}" class="quick-action-card">
                <i class="iconoir-plus"></i>
                <span>{{ _('Nouveau Quiz') }}</span>
            </a>
            <a href="{{ url_for('admin.generate_quiz') }}" class="quick-action-card">
                <i class="iconoir-sparks"></i>
                <span>{{ _('Generator IA') }}</span>
            </a>
            <a href="{{ url_for('interview.admin_list') }}" class="quick-action-card">
                <i class="iconoir-chat-bubble"></i>
                <span>{{ _('Entretiens') }}</span>
            </a>
            <a href="{{ url_for('interview.admin_create') }}" class="quick-action-card">
                <i class="iconoir-plus"></i>
                <span>{{ _('Nouvel Entretien') }}</span>
            </a>
            <a href="{{ url_for('admin.groups') }}" class="quick-action-card">
                <i class="iconoir-group"></i>
                <span>{{ _('Groupes') }}</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}
