{% extends "base.html" %}

{% block title %}Dashboard Admin - BrainNotFound{% endblock %}

{% block content %}
<h1 class="mb-2">Dashboard Administrateur</h1>

{% if fallback_warnings %}
<div class="alert alert-warning mb-2">
    <i class="iconoir-warning-triangle"></i>
    <div>
        <strong>Configuration par defaut detectee</strong>
        <ul class="mt-1 mb-0" style="margin-left: 1.5em;">
        {% for warning in fallback_warnings %}
            <li>{{ warning.message }}</li>
        {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_quizzes }}</div>
        <div class="stat-label">Quiz créés</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_interviews or 0 }}</div>
        <div class="stat-label">Entretiens</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_groups }}</div>
        <div class="stat-label">Groupes</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_users }}</div>
        <div class="stat-label">Utilisateurs</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_responses }}</div>
        <div class="stat-label">Réponses soumises</div>
    </div>
</div>

{% if pending_grading > 0 %}
<div class="alert alert-warning mb-2">
    <i class="iconoir-hourglass"></i>
    <span><strong>{{ pending_grading }}</strong> correction(s) en attente ou en cours</span>
</div>
{% endif %}

{% if recent_interviews %}
<div class="card mb-2">
    <div class="card-header flex justify-between items-center">
        <span><i class="iconoir-chat-bubble"></i> Entretiens recents</span>
        <a href="{{ url_for('interview.admin_list') }}" class="btn btn-secondary btn-small">Voir tout</a>
    </div>
    <div class="recent-activity">
        {% for session in recent_interviews %}
        <div class="activity-item flex justify-between items-center gap-sm">
            <div class="flex-1">
                <a href="{{ url_for('admin.user_grades', user_id=session.user.id) }}" class="font-medium link-primary">
                    {{ session.user.full_name }}
                </a>
                a passe
                <a href="{{ url_for('interview.admin_session', interview_id=session.interview.id, session_id=session.id) }}" class="link-primary">
                    {{ session.interview.title|truncate(30) }}
                </a>
            </div>
            <div class="flex gap-sm items-center">
                {% if session.status == 'completed' %}
                {% set percentage = session.get_score_percentage() %}
                <span class="badge {% if percentage >= 80 %}badge-success{% elif percentage >= 50 %}badge-warning{% else %}badge-error{% endif %}">
                    {{ "%.0f"|format(percentage) }}%
                </span>
                {% elif session.status == 'in_progress' %}
                <span class="badge badge-warning">En cours</span>
                {% elif session.status == 'evaluating' %}
                <span class="badge badge-info">Evaluation</span>
                {% endif %}
                <span class="text-light text-sm">{{ session.started_at.strftime('%d/%m %H:%M') }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if all_groups %}
<div class="card mb-2">
    <div class="card-header flex justify-between items-center">
        <span><i class="iconoir-group"></i> Mes Groupes</span>
        <a href="{{ url_for('admin.groups') }}" class="btn btn-secondary btn-small">Voir tout</a>
    </div>
    <div class="group-codes-grid">
        {% for group in all_groups[:6] %}
        <div class="group-code-card">
            <div class="group-code-name">{{ group.name }}</div>
            <div class="group-code-value">
                <span class="font-mono">{{ group.join_code }}</span>
                <button type="button" class="btn btn-icon btn-small" onclick="copyToClipboard('{{ group.join_code }}')" data-tooltip="Copier le code">
                    <i class="iconoir-copy"></i>
                </button>
            </div>
            <div class="group-code-meta text-sm text-light">
                {{ group.get_member_count() }}{% if group.max_members and group.max_members > 0 %}/{{ group.max_members }}{% endif %} membre(s)
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if recent_responses %}
<div class="card mb-2">
    <div class="card-header">
        <i class="iconoir-clock"></i> Activite recente
    </div>
    <div class="recent-activity">
        {% for response in recent_responses %}
        <div class="activity-item flex justify-between items-center gap-sm">
            <div class="flex-1">
                <a href="{{ url_for('admin.user_grades', user_id=response.user.id) }}" class="font-medium link-primary">
                    {{ response.user.full_name }}
                </a>
                a soumis
                <a href="{{ url_for('admin.quiz_results', quiz_id=response.quiz.id) }}" class="link-primary">
                    {{ response.quiz.title|truncate(30) }}
                </a>
            </div>
            <div class="flex gap-sm items-center">
                {% set percentage = (response.total_score / response.max_score * 100) if response.max_score > 0 else 0 %}
                <span class="badge {% if percentage >= 80 %}badge-success{% elif percentage >= 50 %}badge-warning{% else %}badge-error{% endif %}">
                    {{ "%.0f"|format(percentage) }}%
                </span>
                <span class="text-light text-sm">{{ response.submitted_at.strftime('%d/%m %H:%M') }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <i class="iconoir-rocket"></i> Actions rapides
    </div>
    <div class="card-body">
        <div class="quick-actions-grid">
            <a href="{{ url_for('admin.quiz_list') }}" class="quick-action-card">
                <i class="iconoir-clipboard-check"></i>
                <span>Voir les Quiz</span>
            </a>
            <a href="{{ url_for('admin.create_quiz') }}" class="quick-action-card">
                <i class="iconoir-plus"></i>
                <span>Nouveau Quiz</span>
            </a>
            <a href="{{ url_for('admin.generate_quiz') }}" class="quick-action-card">
                <i class="iconoir-sparks"></i>
                <span>Generator IA</span>
            </a>
            <a href="{{ url_for('interview.admin_list') }}" class="quick-action-card">
                <i class="iconoir-chat-bubble"></i>
                <span>Entretiens</span>
            </a>
            <a href="{{ url_for('interview.admin_create') }}" class="quick-action-card">
                <i class="iconoir-plus"></i>
                <span>Nouvel Entretien</span>
            </a>
            <a href="{{ url_for('admin.groups') }}" class="quick-action-card">
                <i class="iconoir-group"></i>
                <span>Groupes</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}
