{% extends "base.html" %}

{% block title %}Preview: {{ quiz.title }} - BrainNotFound{% endblock %}

{% block content %}
<div class="preview-banner flex justify-between items-center flex-wrap gap-md">
    <div>
        <h3>Mode Preview</h3>
        <p class="text-sm" style="opacity: 0.9;">
            Visualisation du quiz comme un etudiant le verra (avec les reponses correctes visibles)
        </p>
    </div>
    <div class="flex gap-sm">
        <a href="{{ url_for('admin.test_quiz', identifier=quiz.get_url_identifier()) }}" class="btn btn-small btn-primary">
            <i class="iconoir-play"></i> Tester le quiz
        </a>
        <a href="{{ url_for('admin.edit_quiz', identifier=quiz.get_url_identifier()) }}" class="btn btn-small btn-secondary-inverse">
            <i class="iconoir-edit-pencil"></i> Modifier
        </a>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-small btn-ghost">
            <i class="iconoir-arrow-left"></i> Dashboard
        </a>
    </div>
</div>

{% if existing_test %}
<div class="alert alert-info mb-2">
    <i class="iconoir-info-circle"></i>
    <span>Vous avez déjà testé ce quiz.
        <a href="{{ url_for('quiz.result', identifier=existing_test.get_url_identifier()) }}">Voir les résultats</a>
        ou cliquez sur "Tester le quiz" pour recommencer.
    </span>
</div>
{% endif %}

<h1 class="mb-2">{{ quiz.title }}</h1>

{% if quiz.time_limit_minutes %}
<div class="alert alert-info flex justify-between items-center">
    <span><strong>Temps limite :</strong> {{ quiz.time_limit_minutes }} minutes</span>
</div>
{% endif %}

{% if quiz.description %}
<div class="card mb-2">
    <p>{{ quiz.description }}</p>
</div>
{% endif %}

<div class="info-box bg-gray text-sm mb-2">
    <strong>Informations du quiz :</strong>
    <ul class="info-list">
        <li>Questions : {{ questions|length }}</li>
        <li>Points total : {{ questions|sum(attribute='points') }}</li>
        {% if quiz.randomize_questions %}
        <li class="text-info">Ordre aleatoire des questions active</li>
        {% endif %}
        {% if quiz.available_from or quiz.available_until %}
        <li>Disponibilite :
            {% if quiz.available_from %}du {{ quiz.available_from|localtime }}{% endif %}
            {% if quiz.available_until %}jusqu'au {{ quiz.available_until|localtime }}{% endif %}
        </li>
        {% endif %}
        {% if quiz.groups.count() > 0 %}
        <li>Groupes : {{ quiz.groups.all()|map(attribute='name')|join(', ') }}</li>
        {% else %}
        <li>Groupes : Tous les utilisateurs</li>
        {% endif %}
        <li>Severite correction : {{ quiz.grading_severity or 'modere' }}</li>
    </ul>
</div>

{% for question in questions %}
<div class="question relative">
    <div class="question-header">
        <span class="question-type">{{ question.question_type|upper }}</span>
        <span class="question-points">{{ question.points }} point(s)</span>
    </div>

    <div class="question-text">{{ question.question_text|render_quiz_images(quiz.id) }}</div>

    {% if question.question_type == 'mcq' %}
        <ul class="options">
            {% for option in question.options %}
            <li class="option {{ 'option-correct' if loop.index0 in question.correct_answers else '' }}">
                <label class="cursor-default">
                    {% if question.allow_multiple %}
                        <input type="checkbox" disabled {% if loop.index0 in question.correct_answers %}checked{% endif %}>
                    {% else %}
                        <input type="radio" disabled {% if loop.index0 in question.correct_answers %}checked{% endif %}>
                    {% endif %}
                    {{ option|render_quiz_images(quiz.id) }}
                    {% if loop.index0 in question.correct_answers %}
                    <span class="text-success ml-1 font-medium">(Correct)</span>
                    {% endif %}
                </label>
            </li>
            {% endfor %}
        </ul>
        {% if question.allow_multiple %}
        <p class="text-sm text-light mt-1">
            <em>Plusieurs reponses possibles</em>
        </p>
        {% endif %}
    {% else %}
        <div class="form-group mt-1">
            <textarea class="form-textarea" placeholder="Zone de reponse de l'etudiant..." disabled></textarea>
        </div>
        {% if question.expected_answer %}
        <div class="expected-answer mt-1">
            <strong class="text-success block mb-0">Reponse attendue :</strong>
            <div class="whitespace-pre">{{ question.expected_answer }}</div>
        </div>
        {% else %}
        <div class="warning-box mt-1">
            <span class="text-warning"><strong>Attention :</strong> Pas de reponse attendue definie - l'IA notera sans reference</span>
        </div>
        {% endif %}
    {% endif %}
</div>
{% endfor %}

<div class="actions border-t pt-2 mt-2">
    <a href="{{ url_for('admin.edit_quiz', identifier=quiz.get_url_identifier()) }}" class="btn btn-primary">
        <i class="iconoir-edit-pencil"></i> Modifier le quiz
    </a>
    <a href="{{ url_for('admin.quiz_results', identifier=quiz.get_url_identifier()) }}" class="btn btn-secondary">
        <i class="iconoir-stats-report"></i> Voir les resultats
    </a>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
        <i class="iconoir-arrow-left"></i> Retour au dashboard
    </a>
</div>
{% endblock %}
