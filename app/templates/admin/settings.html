{% extends "base.html" %}

{% block title %}{{ _('Parametres du site') }} - {{ site_title }}{% endblock %}

{% block content %}
<h1 class="mb-2">{{ _('Parametres du site') }}</h1>

<form method="POST" id="settings-form">
    <!-- Site Branding -->
    <div class="card mb-2">
        <div class="card-header">
            <i class="iconoir-home-alt"></i> {{ _('Identite du site') }}
        </div>
        <div class="p-2">
            <div class="form-group">
                <label for="site_title" class="form-label">{{ _('Nom du site') }}</label>
                <input type="text" id="site_title" name="site_title" class="form-input"
                       value="{{ settings.site_title }}" maxlength="100" required>
                <small class="text-light">{{ _('Affiche dans la barre de navigation et les titres de page') }}</small>
            </div>

            <div class="form-group mb-0">
                <label for="contact_email" class="form-label">{{ _('Email de contact') }}</label>
                <input type="email" id="contact_email" name="contact_email" class="form-input"
                       value="{{ settings.contact_email }}" maxlength="255">
                <small class="text-light">{{ _('Email affiche pour le support et les notifications') }}</small>
            </div>
        </div>
    </div>

    <!-- Custom Pages -->
    <div class="card mb-2">
        <div class="card-header flex justify-between items-center">
            <span><i class="iconoir-page"></i> {{ _('Pages personnalisees') }}</span>
            <a href="{{ url_for('admin.pages') }}" class="btn btn-primary btn-small">
                <i class="iconoir-edit-pencil"></i> {{ _('Gerer les pages') }}
            </a>
        </div>
        <div class="p-2">
            <p class="text-light mb-0">
                {{ _('Creez des pages personnalisees (mentions legales, CGU, a propos, etc.) en Markdown.') }}
                {{ _('Ces pages peuvent etre affichees dans le menu ou le footer du site.') }}
            </p>
        </div>
    </div>

    <!-- Backup Configuration -->
    <div class="card mb-2">
        <div class="card-header flex justify-between items-center">
            <span><i class="iconoir-database-backup"></i> {{ _('Sauvegardes automatiques') }}</span>
            <label class="checkbox-label mb-0">
                <input type="checkbox" name="ftp_enabled" id="ftp_enabled"
                       {{ 'checked' if settings.ftp_enabled }}>
                <span>{{ _('Activer') }}</span>
            </label>
        </div>

        <div class="p-2" id="backup-settings">
            <!-- FTP Settings -->
            <div class="grid grid-cols-2 gap-md">
                <div class="form-group">
                    <label for="ftp_host" class="form-label">{{ _('Serveur FTP') }}</label>
                    <input type="text" id="ftp_host" name="ftp_host" class="form-input"
                           value="{{ settings.ftp_host or '' }}" placeholder="ftp.example.com">
                </div>

                <div class="form-group">
                    <label for="ftp_port" class="form-label">{{ _('Port') }}</label>
                    <input type="number" id="ftp_port" name="ftp_port" class="form-input"
                           value="{{ settings.ftp_port or 21 }}" min="1" max="65535">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-md">
                <div class="form-group">
                    <label for="ftp_username" class="form-label">{{ _("Nom d'utilisateur") }}</label>
                    <input type="text" id="ftp_username" name="ftp_username" class="form-input"
                           value="{{ settings.ftp_username or '' }}" autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="ftp_password" class="form-label">{{ _('Mot de passe') }}</label>
                    <input type="password" id="ftp_password" name="ftp_password" class="form-input"
                           placeholder="{{ _('Inchange') if settings.ftp_password_encrypted else _('Non defini') }}"
                           autocomplete="new-password">
                    <small class="text-light">{{ _("Laissez vide pour conserver l'actuel") }}</small>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-md">
                <div class="form-group">
                    <label for="ftp_path" class="form-label">{{ _('Chemin distant') }}</label>
                    <input type="text" id="ftp_path" name="ftp_path" class="form-input"
                           value="{{ settings.ftp_path or '/backups' }}" placeholder="/backups">
                </div>

                <div class="form-group">
                    <label class="checkbox-label mt-2">
                        <input type="checkbox" name="ftp_use_tls" {{ 'checked' if settings.ftp_use_tls }}>
                        <span>{{ _('Utiliser FTPS (TLS)') }}</span>
                    </label>
                    <small class="text-light d-block">{{ _('Recommande pour la securite') }}</small>
                </div>
            </div>

            <div class="flex gap-md mb-2">
                <button type="button" class="btn btn-secondary btn-small" id="test-ftp-btn">
                    <i class="iconoir-server-connection"></i> {{ _('Tester la connexion') }}
                </button>
                <span id="ftp-test-result" class="text-light"></span>
            </div>

            <hr class="my-2">

            <!-- Backup Schedule -->
            <h4 class="mb-1">{{ _('Planification') }}</h4>

            <div class="grid grid-cols-3 gap-md">
                <div class="form-group">
                    <label for="backup_frequency" class="form-label">{{ _('Frequence') }}</label>
                    <select id="backup_frequency" name="backup_frequency" class="form-select">
                        <option value="hourly" {{ 'selected' if settings.backup_frequency == 'hourly' }}>{{ _('Toutes les heures') }}</option>
                        <option value="daily" {{ 'selected' if settings.backup_frequency == 'daily' }}>{{ _('Quotidien') }}</option>
                        <option value="weekly" {{ 'selected' if settings.backup_frequency == 'weekly' }}>{{ _('Hebdomadaire') }}</option>
                    </select>
                </div>

                <div class="form-group" id="hour-group">
                    <label for="backup_hour" class="form-label">{{ _('Heure (0-23)') }}</label>
                    <input type="number" id="backup_hour" name="backup_hour" class="form-input"
                           value="{{ settings.backup_hour or 3 }}" min="0" max="23">
                </div>

                <div class="form-group" id="day-group" style="display: none;">
                    <label for="backup_day" class="form-label">{{ _('Jour de la semaine') }}</label>
                    <select id="backup_day" name="backup_day" class="form-select">
                        <option value="0" {{ 'selected' if settings.backup_day == 0 }}>{{ _('Lundi') }}</option>
                        <option value="1" {{ 'selected' if settings.backup_day == 1 }}>{{ _('Mardi') }}</option>
                        <option value="2" {{ 'selected' if settings.backup_day == 2 }}>{{ _('Mercredi') }}</option>
                        <option value="3" {{ 'selected' if settings.backup_day == 3 }}>{{ _('Jeudi') }}</option>
                        <option value="4" {{ 'selected' if settings.backup_day == 4 }}>{{ _('Vendredi') }}</option>
                        <option value="5" {{ 'selected' if settings.backup_day == 5 }}>{{ _('Samedi') }}</option>
                        <option value="6" {{ 'selected' if settings.backup_day == 6 }}>{{ _('Dimanche') }}</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="backup_retention_days" class="form-label">{{ _('Conservation (jours)') }}</label>
                <input type="number" id="backup_retention_days" name="backup_retention_days" class="form-input"
                       value="{{ settings.backup_retention_days or 30 }}" min="1" max="365" style="width: 150px;">
                <small class="text-light">{{ _('Les sauvegardes plus anciennes seront supprimees automatiquement') }}</small>
            </div>

            {% if next_backup %}
            <div class="alert alert-info">
                <i class="iconoir-clock"></i>
                {{ _('Prochaine sauvegarde prevue :') }} <strong>{{ next_backup|localtime }}</strong>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Last Backup Status -->
    {% if settings.last_backup_at %}
    <div class="card mb-2">
        <div class="card-header">
            <i class="iconoir-clock"></i> {{ _('Derniere sauvegarde') }}
        </div>
        <div class="p-2">
            <div class="grid grid-cols-3 gap-md">
                <div>
                    <span class="text-light">{{ _('Date') }}</span><br>
                    <strong>{{ settings.last_backup_at|localtime }}</strong>
                </div>
                <div>
                    <span class="text-light">{{ _('Statut') }}</span><br>
                    {% if settings.last_backup_status == 'success' %}
                    <span class="badge badge-success">{{ _('Succes') }}</span>
                    {% else %}
                    <span class="badge badge-error">{{ _('Echec') }}</span>
                    {% endif %}
                </div>
                <div>
                    <span class="text-light">{{ _('Taille') }}</span><br>
                    <strong>
                        {% if settings.last_backup_size %}
                            {% if settings.last_backup_size > 1048576 %}
                                {{ (settings.last_backup_size / 1048576)|round(2) }} Mo
                            {% else %}
                                {{ (settings.last_backup_size / 1024)|round(2) }} Ko
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </strong>
                </div>
            </div>
            {% if settings.last_backup_message %}
            <div class="mt-1">
                <span class="text-light">{{ _('Message:') }}</span>
                <code class="text-small">{{ settings.last_backup_message }}</code>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Manual Backup & History -->
    <div class="card mb-2">
        <div class="card-header">
            <i class="iconoir-database-restore"></i> {{ _('Actions manuelles') }}
        </div>
        <div class="p-2">
            <div class="alert alert-info mb-1">
                <i class="iconoir-info-circle"></i>
                {{ _('Les sauvegardes incluent la') }} <strong>{{ _('base de donnees') }}</strong> {{ _('et les') }} <strong>{{ _('fichiers uploades') }}</strong> {{ _('(images, PDF des quiz).') }}
            </div>
            <div class="flex gap-md items-center flex-wrap">
                <button type="button" class="btn btn-primary" id="run-backup-btn">
                    <i class="iconoir-download"></i> {{ _('Lancer une sauvegarde maintenant') }}
                </button>
                <button type="button" class="btn btn-secondary" id="view-history-btn">
                    <i class="iconoir-folder"></i> {{ _("Voir l'historique") }}
                </button>
                <span id="backup-result" class="text-light"></span>
            </div>

            <!-- Backup History (hidden by default) -->
            <div id="backup-history" style="display: none;" class="mt-2">
                <h4>{{ _('Historique des sauvegardes') }}</h4>
                <div id="backup-history-content">
                    <p class="text-light">{{ _('Chargement...') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="flex gap-md">
        <button type="submit" class="btn btn-primary">
            <i class="iconoir-floppy-disk"></i> {{ _('Enregistrer les parametres') }}
        </button>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
            <i class="iconoir-arrow-left"></i> {{ _('Retour') }}
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const frequencySelect = document.getElementById('backup_frequency');
    const hourGroup = document.getElementById('hour-group');
    const dayGroup = document.getElementById('day-group');
    const ftpEnabled = document.getElementById('ftp_enabled');
    const backupSettings = document.getElementById('backup-settings');

    // Toggle backup settings visibility
    function updateBackupVisibility() {
        const inputs = backupSettings.querySelectorAll('input:not(#ftp_enabled), select, button');
        inputs.forEach(el => {
            el.disabled = !ftpEnabled.checked;
        });
        backupSettings.style.opacity = ftpEnabled.checked ? '1' : '0.5';
    }

    ftpEnabled.addEventListener('change', updateBackupVisibility);
    updateBackupVisibility();

    // Toggle hour/day visibility based on frequency
    function updateScheduleFields() {
        const freq = frequencySelect.value;
        hourGroup.style.display = freq === 'hourly' ? 'none' : 'block';
        dayGroup.style.display = freq === 'weekly' ? 'block' : 'none';
    }

    frequencySelect.addEventListener('change', updateScheduleFields);
    updateScheduleFields();

    // Test FTP connection
    document.getElementById('test-ftp-btn').addEventListener('click', async function() {
        const btn = this;
        const result = document.getElementById('ftp-test-result');

        btn.disabled = true;
        result.textContent = {{ _("Test en cours...")|tojson }};
        result.className = 'text-light';

        try {
            const response = await fetch('{{ url_for("admin.test_ftp_connection") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            });
            const data = await response.json();

            if (data.success) {
                result.textContent = data.message;
                result.className = 'text-success';
            } else {
                result.textContent = data.message;
                result.className = 'text-error';
            }
        } catch (error) {
            result.textContent = {{ _("Erreur:")|tojson }} + ' ' + error.message;
            result.className = 'text-error';
        }

        btn.disabled = false;
    });

    // Run manual backup
    document.getElementById('run-backup-btn').addEventListener('click', async function() {
        const btn = this;
        const result = document.getElementById('backup-result');

        if (!confirm({{ _("Lancer une sauvegarde maintenant ?")|tojson }})) return;

        btn.disabled = true;
        result.textContent = {{ _("Sauvegarde en cours...")|tojson }};
        result.className = 'text-light';

        try {
            const response = await fetch('{{ url_for("admin.run_manual_backup") }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            });
            const data = await response.json();

            if (data.success) {
                result.textContent = data.message;
                result.className = 'text-success';
                // Reload page to show updated status
                setTimeout(() => location.reload(), 2000);
            } else {
                result.textContent = data.message;
                result.className = 'text-error';
            }
        } catch (error) {
            result.textContent = {{ _("Erreur:")|tojson }} + ' ' + error.message;
            result.className = 'text-error';
        }

        btn.disabled = false;
    });

    // View backup history
    document.getElementById('view-history-btn').addEventListener('click', async function() {
        const historyDiv = document.getElementById('backup-history');
        const contentDiv = document.getElementById('backup-history-content');

        if (historyDiv.style.display === 'none') {
            historyDiv.style.display = 'block';
            contentDiv.innerHTML = '<p class="text-light">' + {{ _("Chargement...")|tojson }} + '</p>';

            try {
                const response = await fetch('{{ url_for("admin.backup_history") }}');
                const data = await response.json();

                if (data.error) {
                    contentDiv.innerHTML = '<p class="text-error">' + data.error + '</p>';
                } else if (data.files.length === 0) {
                    contentDiv.innerHTML = '<p class="text-light">' + {{ _("Aucune sauvegarde trouvee")|tojson }} + '</p>';
                } else {
                    let html = '<div class="alert alert-warning mb-1"><i class="iconoir-warning-triangle"></i> <strong>' + {{ _("Attention:")|tojson }} + '</strong> ' + {{ _("La restauration remplacera toutes les donnees actuelles!")|tojson }} + '</div>';
                    html += '<table class="table table-small"><thead><tr><th>' + {{ _("Fichier")|tojson }} + '</th><th>' + {{ _("Type")|tojson }} + '</th><th>' + {{ _("Taille")|tojson }} + '</th><th>' + {{ _("Date")|tojson }} + '</th><th>' + {{ _("Action")|tojson }} + '</th></tr></thead><tbody>';
                    data.files.forEach(file => {
                        const sizeKb = (file.size / 1024).toFixed(1);
                        const sizeMb = (file.size / 1048576).toFixed(2);
                        const sizeDisplay = file.size > 1048576 ? sizeMb + ' Mo' : sizeKb + ' Ko';
                        const typeLabel = file.type === 'full' ? '<span class="badge badge-success" title="' + {{ _("Base de donnees + images")|tojson }} + '">' + {{ _("Complet")|tojson }} + '</span>' : '<span class="badge badge-warning" title="' + {{ _("Base de donnees uniquement")|tojson }} + '">' + {{ _("BDD seule")|tojson }} + '</span>';
                        html += '<tr><td><code class="text-small">' + file.name + '</code></td><td>' + typeLabel + '</td><td>' + sizeDisplay + '</td><td>' + file.date + '</td>';
                        html += '<td><button type="button" class="btn btn-error btn-small restore-btn" data-filename="' + file.name + '"><i class="iconoir-database-restore"></i> ' + {{ _("Restaurer")|tojson }} + '</button></td></tr>';
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;

                    // Add restore button handlers
                    contentDiv.querySelectorAll('.restore-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const filename = this.dataset.filename;
                            if (!confirm({{ _("ATTENTION: Cette action va remplacer TOUTES les donnees actuelles par celles du backup")|tojson }} + ' "' + filename + '".\n\n' + {{ _("Cette action est IRREVERSIBLE.")|tojson }} + '\n\n' + {{ _("Continuer ?")|tojson }})) return;
                            if (!confirm({{ _("Derniere confirmation: Etes-vous VRAIMENT sur de vouloir restaurer ce backup ?")|tojson }})) return;

                            this.disabled = true;
                            this.innerHTML = '<i class="iconoir-refresh"></i> ' + {{ _("Restauration...")|tojson }};

                            try {
                                const response = await fetch('{{ url_for("admin.restore_backup") }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                                    },
                                    body: JSON.stringify({ filename: filename })
                                });
                                const result = await response.json();

                                if (result.success) {
                                    alert({{ _("Restauration reussie!")|tojson }} + '\n\n' + result.message + '\n\n' + {{ _("La page va se recharger.")|tojson }});
                                    location.reload();
                                } else {
                                    alert({{ _("Erreur:")|tojson }} + ' ' + result.message);
                                    this.disabled = false;
                                    this.innerHTML = '<i class="iconoir-database-restore"></i> ' + {{ _("Restaurer")|tojson }};
                                }
                            } catch (error) {
                                alert({{ _("Erreur:")|tojson }} + ' ' + error.message);
                                this.disabled = false;
                                this.innerHTML = '<i class="iconoir-database-restore"></i> ' + {{ _("Restaurer")|tojson }};
                            }
                        });
                    });
                }
            } catch (error) {
                contentDiv.innerHTML = '<p class="text-error">' + {{ _("Erreur:")|tojson }} + ' ' + error.message + '</p>';
            }

            this.innerHTML = '<i class="iconoir-eye-closed"></i> ' + {{ _("Masquer l'historique")|tojson }};
        } else {
            historyDiv.style.display = 'none';
            this.innerHTML = '<i class="iconoir-folder"></i> ' + {{ _("Voir l'historique")|tojson }};
        }
    });
});
</script>
{% endblock %}
