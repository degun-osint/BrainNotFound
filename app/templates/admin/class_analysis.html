{% extends "base.html" %}

{% block title %}Analyse de classe - {{ quiz.title }} - BrainNotFound{% endblock %}

{% block extra_css %}
<style>
    .analysis-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-box {
        background: var(--gray-100);
        border: 1px solid var(--border);
        padding: 1rem;
        text-align: center;
    }

    .stat-box h3 {
        font-size: 0.75rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .stat-box .value {
        font-size: 1.75rem;
        font-weight: 600;
        font-family: var(--font-mono);
    }

    .stat-box .value.success { color: var(--accent-success); }
    .stat-box .value.warning { color: var(--accent-warning); }
    .stat-box .value.danger { color: var(--accent-error); }

    .question-stats-table {
        width: 100%;
        margin-bottom: 2rem;
    }

    .question-stats-table th,
    .question-stats-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
    }

    .question-stats-table th {
        background: var(--gray-100);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .question-stats-table td.mono {
        font-family: var(--font-mono);
    }

    .student-row {
        display: grid;
        grid-template-columns: 200px 80px 80px 80px 1fr;
        gap: 1rem;
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-light);
        align-items: center;
    }

    .student-row:hover {
        background: var(--gray-100);
    }

    .student-row.header {
        background: var(--gray-100);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .time-cells {
        display: flex;
        gap: 0.25rem;
    }

    .time-cell {
        width: 32px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-family: var(--font-mono);
        border-radius: 2px;
    }

    .time-cell.fast {
        background: var(--accent-success);
        color: white;
    }

    .time-cell.normal {
        background: var(--gray-200);
    }

    .time-cell.slow {
        background: var(--accent-error);
        color: white;
    }

    .ai-result {
        padding: 1.5rem;
        border: 1px solid var(--border);
        margin-top: 1rem;
    }

    .ai-result.low {
        background: rgba(45, 90, 39, 0.1);
        border-color: var(--accent-success);
    }

    .ai-result.medium {
        background: rgba(139, 105, 20, 0.1);
        border-color: var(--accent-warning);
    }

    .ai-result.high {
        background: rgba(139, 32, 32, 0.1);
        border-color: var(--accent-error);
    }

    .risk-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        font-family: var(--font-mono);
    }

    .risk-badge.low { background: var(--accent-success); color: white; }
    .risk-badge.medium { background: var(--accent-warning); color: white; }
    .risk-badge.high { background: var(--accent-error); color: white; }

    .question-concern {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: rgba(139, 105, 20, 0.1);
        border-left: 3px solid var(--accent-warning);
    }

    .recommendations {
        list-style: disc;
        margin-left: 1.5rem;
    }

    .recommendations li {
        margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
        .student-row {
            grid-template-columns: 1fr;
        }
        .time-cells {
            flex-wrap: wrap;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analysis-header">
    <div>
        <h1 class="mb-0">Analyse de classe</h1>
        <span class="text-light">{{ quiz.title }}</span>
    </div>
    <div class="flex gap-sm">
        {% if not quiz.class_analysis_result %}
        <button type="button" class="btn btn-primary" id="analyze-btn" onclick="runClassAnalysis()">
            <i class="iconoir-sparks"></i> Lancer l'analyse IA
        </button>
        {% else %}
        <button type="button" class="btn btn-secondary" id="analyze-btn" onclick="runClassAnalysis()">
            <i class="iconoir-refresh-double"></i> Relancer l'analyse
        </button>
        {% endif %}
    </div>
</div>

<!-- Global Stats -->
<div class="stats-overview">
    <div class="stat-box">
        <h3>Etudiants</h3>
        <div class="value">{{ stats.global_stats.student_count }}</div>
    </div>
    <div class="stat-box">
        <h3>Duree moyenne</h3>
        <div class="value">{{ stats.global_stats.avg_duration }} min</div>
    </div>
    <div class="stat-box">
        <h3>Score moyen</h3>
        <div class="value {% if stats.global_stats.avg_score >= 70 %}success{% elif stats.global_stats.avg_score >= 50 %}warning{% else %}danger{% endif %}">
            {{ stats.global_stats.avg_score }}%
        </div>
    </div>
    <div class="stat-box">
        <h3>Pertes de focus</h3>
        <div class="value {% if stats.global_stats.total_focus_events == 0 %}success{% elif stats.global_stats.total_focus_events < 10 %}warning{% else %}danger{% endif %}">
            {{ stats.global_stats.total_focus_events }}
        </div>
    </div>
    <div class="stat-box">
        <h3>Avec focus issues</h3>
        <div class="value {% if stats.global_stats.students_with_focus_issues == 0 %}success{% else %}warning{% endif %}">
            {{ stats.global_stats.students_with_focus_issues }}
        </div>
    </div>
</div>

<!-- AI Analysis Result -->
<div class="card mb-2">
    <div class="card-header"><i class="iconoir-sparks"></i> Analyse pedagogique IA</div>

    <div id="analysis-container">
        {% if quiz.class_analysis_result %}
            {% set result = quiz.class_analysis_result %}
            <div class="ai-result low" style="background: var(--gray-50);">

                <!-- Summary -->
                <p class="mb-2" style="font-size: 1.1rem;">{{ result.pedagogical_summary or result.summary }}</p>

                <!-- Class Strengths -->
                {% if result.class_strengths %}
                <div class="mb-2">
                    <h4 class="mb-1"><i class="iconoir-check-circle" style="color: var(--accent-success);"></i> Points forts de la classe</h4>
                    <div class="flex flex-wrap gap-sm">
                        {% for strength in result.class_strengths %}
                        <span class="badge badge-success">{{ strength.topic }} ({{ strength.success_rate }}%)</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Concepts to Review -->
                {% if result.concepts_to_review %}
                <div class="mb-2">
                    <h4 class="mb-1"><i class="iconoir-book" style="color: var(--accent-warning);"></i> Notions a revoir en cours</h4>
                    {% for concept in result.concepts_to_review %}
                    <div class="question-concern" style="background: rgba(139, 105, 20, 0.05);">
                        <strong>{{ concept.topic }}</strong>
                        <span class="badge badge-warning ml-1">{{ concept.success_rate }}% reussite</span>
                        {% if concept.questions_concerned %}
                        <small class="text-light ml-1">(Q{{ concept.questions_concerned|join(', Q') }})</small>
                        {% endif %}
                        <p class="mt-1 mb-1" style="font-size: 0.9rem;">{{ concept.teaching_suggestion }}</p>
                        {% if concept.common_errors %}
                        <small class="text-light">Erreurs frequentes: {{ concept.common_errors|join(', ') }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Students Needing Support -->
                {% if result.students_needing_support %}
                <div class="mb-2">
                    <h4 class="mb-1"><i class="iconoir-user" style="color: var(--primary);"></i> Etudiants a accompagner</h4>
                    {% for student in result.students_needing_support %}
                    <div class="question-concern" style="background: rgba(59, 130, 246, 0.05); border-left-color: var(--primary);">
                        <strong>{{ student.name }}</strong>
                        <ul class="mt-1 mb-1" style="margin-left: 1.25rem; font-size: 0.9rem; color: var(--text-light);">
                            {% for gap in student.gaps %}
                            <li>{{ gap }}</li>
                            {% endfor %}
                        </ul>
                        {% if student.suggested_focus %}
                        <small class="text-light"><i class="iconoir-light-bulb"></i> {{ student.suggested_focus }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Behavioral Observations -->
                {% if result.behavioral_observations %}
                <div class="mb-2">
                    <h4 class="mb-1"><i class="iconoir-eye-solid" style="color: var(--text-light);"></i> Observations comportementales</h4>
                    {% for obs in result.behavioral_observations %}
                    <div class="question-concern" style="background: {% if obs.level == 'attention' %}rgba(139, 105, 20, 0.1){% else %}var(--gray-50){% endif %}; border-left-color: {% if obs.level == 'attention' %}var(--accent-warning){% else %}var(--gray-300){% endif %};">
                        <strong>{{ obs.type }}</strong>
                        {% if obs.students_concerned is string %}
                        <small class="text-light ml-1">({{ obs.students_concerned }})</small>
                        {% elif obs.students_concerned %}
                        <small class="text-light ml-1">({{ obs.students_concerned|join(', ') }})</small>
                        {% endif %}
                        <p class="mt-1 mb-1" style="font-size: 0.9rem;">{{ obs.description }}</p>
                        {% if obs.possible_explanations %}
                        <small class="text-light"><i class="iconoir-info-circle"></i> Explications possibles: {{ obs.possible_explanations|join(', ') }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Recommendations -->
                {% if result.recommendations %}
                <div class="mb-1">
                    <h4 class="mb-1"><i class="iconoir-task-list"></i> Recommandations</h4>
                    {% for rec in result.recommendations %}
                    {% if rec is mapping %}
                    <div class="question-concern" style="background: var(--gray-50); border-left-color: {% if rec.priority == 'high' %}var(--accent-error){% elif rec.priority == 'medium' %}var(--accent-warning){% else %}var(--gray-300){% endif %};">
                        <span class="badge badge-{% if rec.priority == 'high' %}error{% elif rec.priority == 'medium' %}warning{% else %}default{% endif %}">{{ rec.priority }}</span>
                        <strong class="ml-1">{{ rec.action }}</strong>
                        {% if rec.rationale %}
                        <p class="mt-1 mb-0" style="font-size: 0.85rem; color: var(--text-light);">{{ rec.rationale }}</p>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="question-concern" style="background: var(--gray-50); border-left-color: var(--gray-300);">
                        {{ rec }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        {% else %}
            <p class="text-center text-light p-2">
                Cliquez sur "Lancer l'analyse IA" pour obtenir une analyse pedagogique de la classe.
            </p>
        {% endif %}
    </div>
</div>

<!-- Question Stats -->
<div class="card mb-2">
    <div class="card-header">Statistiques par question</div>

    <div class="overflow-x-auto">
        <table class="question-stats-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Type</th>
                    <th>Question</th>
                    <th>Points</th>
                    <th>Temps moy</th>
                    <th>Ecart-type</th>
                    <th>Score moy</th>
                    <th>Focus</th>
                </tr>
            </thead>
            <tbody>
                {% for q in stats.questions %}
                {% set q_stat = stats.question_stats.get(q.id, {}) %}
                <tr>
                    <td class="mono">{{ q.number }}</td>
                    <td>
                        <span class="badge {% if q.type == 'mcq' %}badge-default{% else %}badge-warning{% endif %}">
                            {{ q.type|upper }}
                        </span>
                    </td>
                    <td>{{ q.text[:60] }}{% if q.text|length > 60 %}...{% endif %}</td>
                    <td class="mono">{{ q.points }}</td>
                    <td class="mono">{{ q_stat.avg_time }}s</td>
                    <td class="mono">{{ q_stat.std_time }}s</td>
                    <td class="mono">{{ q_stat.avg_score }}</td>
                    <td>
                        {% if q_stat.total_focus_lost > 0 %}
                        <span class="badge badge-warning">{{ q_stat.total_focus_lost }}</span>
                        {% else %}
                        <span class="text-success">0</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Student Comparison -->
<div class="card mb-2">
    <div class="card-header">Comparaison des etudiants</div>

    <div class="student-row header">
        <span>Etudiant</span>
        <span>Score</span>
        <span>Duree</span>
        <span>Focus</span>
        <span>Temps par question (vert=rapide, rouge=lent)</span>
    </div>

    {% for student in stats.students %}
    <div class="student-row">
        <span>
            <a href="{{ url_for('admin.response_analysis', identifier=student.uid) }}" class="link-primary">
                {{ student.name }}
            </a>
        </span>
        <span class="mono {% if student.percentage >= 70 %}text-success{% elif student.percentage >= 50 %}text-warning{% else %}text-error{% endif %}">
            {{ student.percentage }}%
        </span>
        <span class="mono">{{ (student.total_duration / 60)|round(1) }}m</span>
        <span>
            {% if student.total_focus_lost > 0 %}
            <span class="badge badge-warning">{{ student.total_focus_lost }}</span>
            {% else %}
            <span class="text-success">0</span>
            {% endif %}
        </span>
        <span class="time-cells">
            {% for ans in student.answers %}
                {% set q_stat = stats.question_stats.get(ans.question_id, {}) %}
                {% set avg_time = q_stat.avg_time or 1 %}
                {% set std_time = q_stat.std_time or 10 %}
                {% set deviation = (ans.time_spent - avg_time) %}
                <span class="time-cell {% if deviation < -std_time %}fast{% elif deviation > std_time %}slow{% else %}normal{% endif %}"
                      title="Q{{ ans.question_number }}: {{ ans.time_spent }}s (moy: {{ avg_time }}s)">
                    {{ ans.time_spent }}
                </span>
            {% endfor %}
        </span>
    </div>
    {% endfor %}
</div>

<div class="mt-2 flex gap-md">
    <a href="{{ url_for('admin.quiz_results', identifier=quiz.get_url_identifier()) }}" class="btn btn-secondary">
        <i class="iconoir-arrow-left"></i> Retour aux resultats
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
const quizId = {{ quiz.id }};

async function runClassAnalysis() {
    const btn = document.getElementById('analyze-btn');
    const container = document.getElementById('analysis-container');

    btn.disabled = true;
    btn.innerHTML = '<i class="iconoir-refresh-double rotating"></i> Analyse en cours...';

    try {
        const response = await fetch('/admin/quiz/' + quizId + '/analyze-class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            btn.disabled = false;
            btn.innerHTML = '<i class="iconoir-sparks"></i> Lancer l\'analyse IA';
        }
    } catch (err) {
        alert('Erreur de connexion');
        btn.disabled = false;
        btn.innerHTML = '<i class="iconoir-sparks"></i> Lancer l\'analyse IA';
    }
}
</script>

<style>
.rotating {
    animation: rotate 1s linear infinite;
}
@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
