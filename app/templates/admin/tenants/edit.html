{% extends "base.html" %}

{% block title %}{{ _('Modifier') }} {{ tenant.name }} - {{ site_title }}{% endblock %}

{% block content %}
<h1 class="mb-2">{{ _('Modifier l\'organisation') }}</h1>

<div class="card">
    <div class="card-header">{{ tenant.name }}</div>

    <form method="POST">
        <div class="form-group">
            <label class="form-label" for="name">{{ _('Nom de l\'organisation') }} *</label>
            <input type="text" id="name" name="name" class="form-input"
                   value="{{ tenant.name }}" required>
        </div>

        <div class="form-group">
            <label class="form-label">{{ _('Slug (URL)') }}</label>
            <input type="text" class="form-input font-mono" value="{{ tenant.slug }}" disabled>
            <small class="text-light">{{ _('Le slug ne peut pas etre modifie') }}</small>
        </div>

        <div class="form-group">
            <label class="form-label" for="description">{{ _('Description') }}</label>
            <textarea id="description" name="description" class="form-textarea form-textarea-short">{{ tenant.description or '' }}</textarea>
        </div>

        <div class="form-row">
            <div class="form-group flex-1">
                <label class="form-label" for="contact_name">{{ _('Nom du contact') }}</label>
                <input type="text" id="contact_name" name="contact_name" class="form-input"
                       value="{{ tenant.contact_name or '' }}">
            </div>
            <div class="form-group flex-1">
                <label class="form-label" for="contact_email">{{ _('Email du contact') }}</label>
                <input type="email" id="contact_email" name="contact_email" class="form-input"
                       value="{{ tenant.contact_email or '' }}">
            </div>
        </div>

        <h3 class="mt-2 mb-1">{{ _('Limites fixes') }}</h3>
        <div class="info-box bg-gray mb-2">
            <strong>{{ _('Note :') }}</strong> {{ _('0 = illimite. Utilisation actuelle :') }}
            {{ tenant.get_users_count() }} {{ _('utilisateurs') }},
            {{ tenant.get_quizzes_count() }} {{ _('quiz') }},
            {{ tenant.get_groups_count() }} {{ _('groupes') }}
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="max_users">{{ _('Max utilisateurs') }}</label>
                <input type="number" id="max_users" name="max_users" class="form-input"
                       value="{{ tenant.max_users }}" min="0" style="width: 120px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="max_quizzes">{{ _('Max quiz') }}</label>
                <input type="number" id="max_quizzes" name="max_quizzes" class="form-input"
                       value="{{ tenant.max_quizzes }}" min="0" style="width: 120px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="max_groups">{{ _('Max groupes') }}</label>
                <input type="number" id="max_groups" name="max_groups" class="form-input"
                       value="{{ tenant.max_groups }}" min="0" style="width: 120px;">
            </div>
        </div>

        <h3 class="mt-2 mb-1">{{ _('Limites mensuelles IA') }}</h3>
        <div class="info-box bg-gray mb-2">
            <strong>{{ _('Usage ce mois :') }}</strong>
            {{ tenant.used_ai_corrections }} {{ _('corrections') }},
            {{ tenant.used_quiz_generations }} {{ _('generations') }},
            {{ tenant.used_class_analyses }} {{ _('analyses') }},
            {{ tenant.used_interviews }} {{ _('entretiens') }}
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="monthly_ai_corrections">{{ _('Corrections IA / mois') }}</label>
                <input type="number" id="monthly_ai_corrections" name="monthly_ai_corrections" class="form-input"
                       value="{{ tenant.monthly_ai_corrections }}" min="0" style="width: 120px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="monthly_quiz_generations">{{ _('Generations quiz / mois') }}</label>
                <input type="number" id="monthly_quiz_generations" name="monthly_quiz_generations" class="form-input"
                       value="{{ tenant.monthly_quiz_generations }}" min="0" style="width: 120px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="monthly_class_analyses">{{ _('Analyses classe / mois') }}</label>
                <input type="number" id="monthly_class_analyses" name="monthly_class_analyses" class="form-input"
                       value="{{ tenant.monthly_class_analyses }}" min="0" style="width: 120px;">
            </div>
            <div class="form-group">
                <label class="form-label" for="monthly_interviews">{{ _('Entretiens IA / mois') }}</label>
                <input type="number" id="monthly_interviews" name="monthly_interviews" class="form-input"
                       value="{{ tenant.monthly_interviews }}" min="0" style="width: 120px;">
            </div>
        </div>

        <h3 class="mt-2 mb-1">{{ _('Abonnement') }}</h3>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label" for="subscription_expires_at">{{ _('Date d\'expiration') }}</label>
                <input type="date" id="subscription_expires_at" name="subscription_expires_at" class="form-input"
                       value="{{ tenant.subscription_expires_at.strftime('%Y-%m-%d') if tenant.subscription_expires_at else '' }}"
                       style="width: 200px;">
                <small class="text-light">{{ _('Laisser vide pour un abonnement sans expiration') }}</small>
            </div>
            <div class="form-group flex items-end">
                {% if tenant.subscription_expires_at %}
                    {% set days = tenant.days_until_expiration() %}
                    {% if days < 0 %}
                        <span class="badge badge-error">{{ _('Expire depuis') }} {{ -days }} {{ _('jour(s)') }}</span>
                    {% elif days == 0 %}
                        <span class="badge badge-warning">{{ _('Expire aujourd\'hui') }}</span>
                    {% elif days <= 30 %}
                        <span class="badge badge-warning">{{ _('Expire dans') }} {{ days }} {{ _('jour(s)') }}</span>
                    {% else %}
                        <span class="badge badge-success">{{ _('Expire dans') }} {{ days }} {{ _('jour(s)') }}</span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-info">{{ _('Sans expiration') }}</span>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-checkbox">
                <input type="checkbox" name="is_active" {% if tenant.is_active %}checked{% endif %}>
                <span>{{ _('Organisation active') }}</span>
            </label>
            <small class="text-light">{{ _('Desactiver une organisation empeche l\'acces a ses groupes et quiz') }}</small>
        </div>

        <h3 class="mt-2 mb-1">{{ _('Alertes quota') }}</h3>
        <div class="info-box bg-gray mb-2">
            <strong>{{ _('Note :') }}</strong> {{ _('L\'email d\'alerte est envoye a l\'adresse de contact ci-dessus.') }}
            {% if tenant.quota_alert_sent_at %}
            {{ _('Derniere alerte :') }} {{ tenant.quota_alert_sent_at|localtime }}
            {% endif %}
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="quota_alert_enabled" {% if tenant.quota_alert_enabled %}checked{% endif %}>
                    <span>{{ _('Activer les alertes quota') }}</span>
                </label>
                <small class="text-light">{{ _('Envoie un email quand un quota est presque atteint') }}</small>
            </div>
            <div class="form-group">
                <label class="form-label" for="quota_alert_threshold">{{ _('Seuil d\'alerte (%%)') }}</label>
                <input type="number" id="quota_alert_threshold" name="quota_alert_threshold" class="form-input"
                       value="{{ tenant.quota_alert_threshold }}" min="1" max="50" style="width: 100px;">
                <small class="text-light">{{ _('Alerte quand il reste X%% du quota') }}</small>
            </div>
        </div>

        <h3 class="mt-2 mb-1">{{ _('Notes internes') }}</h3>
        <div class="form-group">
            <label class="form-label" for="internal_notes">{{ _('Notes (visibles uniquement par les superadmins)') }}</label>
            <textarea id="internal_notes" name="internal_notes" class="form-textarea"
                      placeholder="{{ _('Notes de facturation, contacts, remarques...') }}">{{ tenant.internal_notes or '' }}</textarea>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-primary">
                <i class="iconoir-check"></i> {{ _('Enregistrer') }}
            </button>
            <a href="{{ url_for('tenant.view_tenant', identifier=tenant.get_url_identifier()) }}" class="btn btn-secondary">
                <i class="iconoir-xmark"></i> {{ _('Annuler') }}
            </a>
        </div>
    </form>
</div>
{% endblock %}
